"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"Event",{enumerable:!0,get:function(){return _event.default}}),Object.defineProperty(exports,"Subscription",{enumerable:!0,get:function(){return _subscription.default}}),exports.default=void 0;var _defaultSymbol2=_interopRequireDefault(require("./default-symbol.js")),_event=_interopRequireDefault(require("./event.js")),_isotropicMake=_interopRequireDefault(require("isotropic-make")),_subscription=_interopRequireDefault(require("./subscription.js"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const _Dispatcher=(0,_isotropicMake.default)({newState(){return Object.assign(Object.create(null),{subscriptions:Object.create(null)})},publish({data,eventName,getDistributionPath,lifecycleHost,publicPublish,publisher,state}){if(publicPublish&&!this._config.allowPublicPublish||state.event)return this;this._config.data&&(data=data?Object.assign(Object.create(null),this._config.data,data):this._config.data),this._config.lifecycleHost&&(lifecycleHost=this._config.lifecycleHost);const config=Object.assign(Object.create(null),{data,dispatchStoppable:this._config.dispatchStoppable,distributionStoppable:this._config.distributionStoppable,eventStoppable:this._config.eventStoppable,name:eventName,preventable:this._config.preventable,publisher}),distributionPath=this._config.distributable?getDistributionPath():new Map([[publisher,state]]),event=this._Event(config);let once;return this._config.publishOnce&&(once=!0,state.event=event),this._config.stages.some(stageName=>{if(config.dispatchStopped=!1,config.distributionStopped=!1,config.stageName=stageName,event.isPrevented(stageName))return this._callLifecycleFunction("preventedFunction",lifecycleHost,event),!0;if(stageName===_defaultSymbol2.default){if(this._config.completeOnce){if(state.event)return!0;once=!0,state.event=event}config.completed=!0,config.distributor=publisher,config.unsubscribe=null,this._callLifecycleFunction("defaultFunction",lifecycleHost,event)}else for(const[distributor,state]of distributionPath)if(state.subscriptions[stageName]){config.distributor=distributor;for(const subscription of state.subscriptions[stageName].values())if(config.unsubscribe=this._unsubscribe.bind(this,subscription),this._callCallbackFunction(subscription.callbackFunction,subscription.host,event),event.dispatchStopped){this._callLifecycleFunction("dispatchStoppedFunction",lifecycleHost,event);break}if(event.distributionStopped){this._callLifecycleFunction("distributionStoppedFunction",lifecycleHost,event);break}}return!!event.eventStopped&&(this._callLifecycleFunction("eventStoppedFunction",lifecycleHost,event),!0)}),once&&(config.distributor=publisher,config.unsubscribe=null),this},subscribe(config){return this._config.lifecycleHost&&(config.lifecycleHost=this._config.lifecycleHost),config.publicSubscription&&!this._config.allowPublicSubscription?this._Subscription():this._callLifecycleFunction("subscribedFunction",config.lifecycleHost,{config,dispatcher:this})||this._subscribe(config)},_callCallbackFunction(callbackFunction,host=this,...args){switch(typeof callbackFunction){case"function":return Reflect.apply(callbackFunction,host,args);case"string":case"symbol":if(callbackFunction=host[callbackFunction],"function"==typeof callbackFunction)return Reflect.apply(callbackFunction,host,args);}},_callLifecycleFunction(name,lifecycleHost,...args){return this._callCallbackFunction(this._config[name],lifecycleHost,...args)},get _Event(){return this._config.Event||this.constructor._Event},_getOnceCallbackFunction(callbackFunction,host=this){switch(typeof callbackFunction){case"function":return function(...args){const[event]=args;return event.unsubscribe(),Reflect.apply(callbackFunction,host,args)};case"string":case"symbol":return function(...args){const[event]=args;if(event.unsubscribe(),callbackFunction=host[callbackFunction],"function"==typeof callbackFunction)return Reflect.apply(callbackFunction,host,args)};}return event=>{event.unsubscribe()}},_init(config={}){return config={...config},!1!==config.allowDuplicateSubscription&&(config.allowDuplicateSubscription=!0),!1!==config.allowPublicPublish&&(config.allowPublicPublish=!0),!1!==config.allowPublicSubscription&&(config.allowPublicSubscription=!0),!1!==config.allowPublicUnsubscription&&(config.allowPublicUnsubscription=!0),config.completeOnce=!config.publishOnce&&!!config.completeOnce,!1!==config.dispatchStoppable&&(config.dispatchStoppable=!0),!1!==config.distributable&&(config.distributable=!0),!1!==config.distributionStoppable&&(config.distributionStoppable=!0),!1!==config.eventStoppable&&(config.eventStoppable=!0),!1===config.preventable||config.preventable instanceof Set||(config.preventable=!0),config.publishOnce=!!config.publishOnce,config.stages||(config.stages=["before","on",_defaultSymbol2.default,"after"]),this._config=config,this},_subscribe(config){if(config.state.event)return config.state.event.isPrevented(config.state.event.stageName)||this._callCallbackFunction(config.callbackFunction,config.host,config.state.event),this._Subscription();config.once&&(config.onceCallbackFunction=config.callbackFunction,config.callbackFunction=this._getOnceCallbackFunction(config.callbackFunction,config.host));let subscriptions=config.state.subscriptions[config.stageName];if(subscriptions||(subscriptions=new Map,config.state.subscriptions[config.stageName]=subscriptions),!this._config.allowDuplicateSubscription)for(const subscription of subscriptions.values())if(subscription.host===config.host&&(subscription.callbackFunction===config.callbackFunction||subscription.onceCallbackFunction&&subscription.onceCallbackFunction===config.onceCallbackFunction))return this._Subscription();return config.subscriptionId=Symbol("subscriptionId"),config.unsubscribe=({publicUnsubscription}={})=>(!publicUnsubscription||this._config.allowPublicUnsubscription)&&this._unsubscribe(config),subscriptions.set(config.subscriptionId,config),config.subscription={subscribed:!0,unsubscribe:config.unsubscribe},this._Subscription(config.subscription)},get _Subscription(){return this._config.Subscription||this.constructor._Subscription},_unsubscribe(config){const subscriptions=config.state.subscriptions[config.stageName],subscription=subscriptions&&subscriptions.get(config.subscriptionId);if(subscription){if(!1===this._callLifecycleFunction("unsubscribedFunction",config.lifecycleHost,{config,dispatcher:this}))return!1;subscriptions.delete(config.subscriptionId),subscriptions.size||Reflect.deleteProperty(config.state.subscriptions,config.stageName)}return config.subscription.subscribed=!1,config.subscription.unsubscribe=null,!0}},{_Event:_event.default,_Subscription:_subscription.default});exports.default=_Dispatcher;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2pzL2Rpc3BhdGNoZXIuanMiXSwibmFtZXMiOlsiX0Rpc3BhdGNoZXIiLCJuZXdTdGF0ZSIsIk9iamVjdCIsImFzc2lnbiIsImNyZWF0ZSIsInN1YnNjcmlwdGlvbnMiLCJwdWJsaXNoIiwiZGF0YSIsImV2ZW50TmFtZSIsImdldERpc3RyaWJ1dGlvblBhdGgiLCJsaWZlY3ljbGVIb3N0IiwicHVibGljUHVibGlzaCIsInB1Ymxpc2hlciIsInN0YXRlIiwiX2NvbmZpZyIsImFsbG93UHVibGljUHVibGlzaCIsImV2ZW50IiwiY29uZmlnIiwiZGlzcGF0Y2hTdG9wcGFibGUiLCJkaXN0cmlidXRpb25TdG9wcGFibGUiLCJldmVudFN0b3BwYWJsZSIsIm5hbWUiLCJwcmV2ZW50YWJsZSIsImRpc3RyaWJ1dGlvblBhdGgiLCJkaXN0cmlidXRhYmxlIiwiTWFwIiwiX0V2ZW50Iiwib25jZSIsInB1Ymxpc2hPbmNlIiwic3RhZ2VzIiwic29tZSIsInN0YWdlTmFtZSIsImRpc3BhdGNoU3RvcHBlZCIsImRpc3RyaWJ1dGlvblN0b3BwZWQiLCJpc1ByZXZlbnRlZCIsIl9jYWxsTGlmZWN5Y2xlRnVuY3Rpb24iLCJfZGVmYXVsdFN5bWJvbCIsImNvbXBsZXRlT25jZSIsImNvbXBsZXRlZCIsImRpc3RyaWJ1dG9yIiwidW5zdWJzY3JpYmUiLCJzdWJzY3JpcHRpb24iLCJ2YWx1ZXMiLCJfdW5zdWJzY3JpYmUiLCJiaW5kIiwiX2NhbGxDYWxsYmFja0Z1bmN0aW9uIiwiY2FsbGJhY2tGdW5jdGlvbiIsImhvc3QiLCJldmVudFN0b3BwZWQiLCJzdWJzY3JpYmUiLCJwdWJsaWNTdWJzY3JpcHRpb24iLCJhbGxvd1B1YmxpY1N1YnNjcmlwdGlvbiIsIl9TdWJzY3JpcHRpb24iLCJkaXNwYXRjaGVyIiwiX3N1YnNjcmliZSIsImFyZ3MiLCJSZWZsZWN0IiwiYXBwbHkiLCJFdmVudCIsImNvbnN0cnVjdG9yIiwiX2dldE9uY2VDYWxsYmFja0Z1bmN0aW9uIiwiX2luaXQiLCJhbGxvd0R1cGxpY2F0ZVN1YnNjcmlwdGlvbiIsImFsbG93UHVibGljVW5zdWJzY3JpcHRpb24iLCJTZXQiLCJvbmNlQ2FsbGJhY2tGdW5jdGlvbiIsInN1YnNjcmlwdGlvbklkIiwiU3ltYm9sIiwicHVibGljVW5zdWJzY3JpcHRpb24iLCJzZXQiLCJzdWJzY3JpYmVkIiwiU3Vic2NyaXB0aW9uIiwiZ2V0IiwiZGVsZXRlIiwic2l6ZSIsImRlbGV0ZVByb3BlcnR5Il0sIm1hcHBpbmdzIjoieW5CQUtBLEtBQU1BLENBQUFBLFdBQVcsQ0FBRywyQkFBTSxDQUN0QkMsUUFBUSxFQUFJLENBQ1IsTUFBT0MsQ0FBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWNELE1BQU0sQ0FBQ0UsTUFBUCxDQUFjLElBQWQsQ0FBZCxDQUFtQyxDQUN0Q0MsYUFBYSxDQUFFSCxNQUFNLENBQUNFLE1BQVAsQ0FBYyxJQUFkLENBRHVCLENBQW5DLENBR1YsQ0FMcUIsQ0FNdEJFLE9BQU8sQ0FBRSxDQUNMQyxJQURLLENBRUxDLFNBRkssQ0FHTEMsbUJBSEssQ0FJTEMsYUFKSyxDQUtMQyxhQUxLLENBTUxDLFNBTkssQ0FPTEMsS0FQSyxDQUFGLENBUUosQ0FDQyxHQUFJRixhQUFhLEVBQUksQ0FBQyxLQUFLRyxPQUFMLENBQWFDLGtCQUEvQixFQUFxREYsS0FBSyxDQUFDRyxLQUEvRCxDQUNJLE1BQU8sS0FBUCxDQUdBLEtBQUtGLE9BQUwsQ0FBYVAsSUFMbEIsR0FNS0EsSUFBSSxDQUFHQSxJQUFJLENBQ1BMLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRCxNQUFNLENBQUNFLE1BQVAsQ0FBYyxJQUFkLENBQWQsQ0FBbUMsS0FBS1UsT0FBTCxDQUFhUCxJQUFoRCxDQUFzREEsSUFBdEQsQ0FETyxDQUVQLEtBQUtPLE9BQUwsQ0FBYVAsSUFSdEIsRUFXSyxLQUFLTyxPQUFMLENBQWFKLGFBWGxCLEdBWUtBLGFBQWEsQ0FBRyxLQUFLSSxPQUFMLENBQWFKLGFBWmxDLEVBZUMsS0FBTU8sQ0FBQUEsTUFBTSxDQUFHZixNQUFNLENBQUND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LGFBQWEsQ0FBQ21FLEdBQWQsQ0FBa0J2RCxNQUFNLENBQUNpRCxjQUF6QixDQUZwQyxDQUlBLEdBQUl6QixZQUFKLENBQWtCLENBQ2QsR0FBSSxVQUFLTixzQkFBTCxDQUE0QixzQkFBNUIsQ0FBb0RsQixNQUFNLENBQUNQLGFBQTNELENBQTBFLENBQzFFTyxNQUQwRSxDQUUxRW9DLFVBQVUsQ0FBRSxJQUY4RCxDQUExRSxDQUFKLENBSUksU0FHSmhELGFBQWEsQ0FBQ29FLE1BQWQsQ0FBcUJ4RCxNQUFNLENBQUNpRCxjQUE1QixDQVJjLENBVVQ3RCxhQUFhLENBQUNxRSxJQVZMLEVBV1ZsQixPQUFPLENBQUNtQixjQUFSLENBQXVCMUQsTUFBTSxDQUFDSixLQUFQLENBQWFSLGFBQXBDLENBQW1EWSxNQUFNLENBQUNjLFNBQTFELENBRVAsQ0FLRCxNQUhBZCxDQUFBQSxNQUFNLENBQUN3QixZQUFQLENBQW9CNkIsVUFBcEIsR0FHQSxDQUZBckQsTUFBTSxDQUFDd0IsWUFBUCxDQUFvQkQsV0FBcEIsQ0FBa0MsSUFFbEMsR0FDSCxDQWhVcUIsQ0FBTixDQWlVakIsQ0FDQ2QsTUFBTSxDQUFOQSxjQURELENBRUMwQixhQUFhLENBQWJBLHFCQUZELENBalVpQixDQUFwQixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF9kZWZhdWx0U3ltYm9sIGZyb20gJy4vZGVmYXVsdC1zeW1ib2wuanMnO1xuaW1wb3J0IF9FdmVudCBmcm9tICcuL2V2ZW50LmpzJztcbmltcG9ydCBfbWFrZSBmcm9tICdpc290cm9waWMtbWFrZSc7XG5pbXBvcnQgX1N1YnNjcmlwdGlvbiBmcm9tICcuL3N1YnNjcmlwdGlvbi5qcyc7XG5cbmNvbnN0IF9EaXNwYXRjaGVyID0gX21ha2Uoe1xuICAgIG5ld1N0YXRlICgpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oT2JqZWN0LmNyZWF0ZShudWxsKSwge1xuICAgICAgICAgICAgc3Vic2NyaXB0aW9uczogT2JqZWN0LmNyZWF0ZShudWxsKVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHB1Ymxpc2ggKHtcbiAgICAgICAgZGF0YSxcbiAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICBnZXREaXN0cmlidXRpb25QYXRoLFxuICAgICAgICBsaWZlY3ljbGVIb3N0LFxuICAgICAgICBwdWJsaWNQdWJsaXNoLFxuICAgICAgICBwdWJsaXNoZXIsXG4gICAgICAgIHN0YXRlXG4gICAgfSkge1xuICAgICAgICBpZiAocHVibGljUHVibGlzaCAmJiAhdGhpcy5fY29uZmlnLmFsbG93UHVibGljUHVibGlzaCB8fCBzdGF0ZS5ldmVudCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fY29uZmlnLmRhdGEpIHtcbiAgICAgICAgICAgIGRhdGEgPSBkYXRhID9cbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKE9iamVjdC5jcmVhdGUobnVsbCksIHRoaXMuX2NvbmZpZy5kYXRhLCBkYXRhKSA6XG4gICAgICAgICAgICAgICAgdGhpcy5fY29uZmlnLmRhdGE7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fY29uZmlnLmxpZmVjeWNsZUhvc3QpIHtcbiAgICAgICAgICAgIGxpZmVjeWNsZUhvc3QgPSB0aGlzLl9jb25maWcubGlmZWN5Y2xlSG9zdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmNyZWF0ZShudWxsKSwge1xuICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgZGlzcGF0Y2hTdG9wcGFibGU6IHRoaXMuX2NvbmZpZy5kaXNwYXRjaFN0b3BwYWJsZSxcbiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb25TdG9wcGFibGU6IHRoaXMuX2NvbmZpZy5kaXN0cmlidXRpb25TdG9wcGFibGUsXG4gICAgICAgICAgICAgICAgZXZlbnRTdG9wcGFibGU6IHRoaXMuX2NvbmZpZy5ldmVudFN0b3BwYWJsZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBldmVudE5hbWUsXG4gICAgICAgICAgICAgICAgcHJldmVudGFibGU6IHRoaXMuX2NvbmZpZy5wcmV2ZW50YWJsZSxcbiAgICAgICAgICAgICAgICBwdWJsaXNoZXJcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgZGlzdHJpYnV0aW9uUGF0aCA9IHRoaXMuX2NvbmZpZy5kaXN0cmlidXRhYmxlID9cbiAgICAgICAgICAgICAgICBnZXREaXN0cmlidXRpb25QYXRoKCkgOlxuICAgICAgICAgICAgICAgIG5ldyBNYXAoW1tcbiAgICAgICAgICAgICAgICAgICAgcHVibGlzaGVyLFxuICAgICAgICAgICAgICAgICAgICBzdGF0ZVxuICAgICAgICAgICAgICAgIF1dKSxcbiAgICAgICAgICAgIGV2ZW50ID0gdGhpcy5fRXZlbnQoY29uZmlnKTtcblxuICAgICAgICBsZXQgb25jZTtcblxuICAgICAgICBpZiAodGhpcy5fY29uZmlnLnB1Ymxpc2hPbmNlKSB7XG4gICAgICAgICAgICBvbmNlID0gdHJ1ZTtcbiAgICAgICAgICAgIHN0YXRlLmV2ZW50ID0gZXZlbnQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9jb25maWcuc3RhZ2VzLnNvbWUoc3RhZ2VOYW1lID0+IHtcbiAgICAgICAgICAgIGNvbmZpZy5kaXNwYXRjaFN0b3BwZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbmZpZy5kaXN0cmlidXRpb25TdG9wcGVkID0gZmFsc2U7XG4gICAgICAgICAgICBjb25maWcuc3RhZ2VOYW1lID0gc3RhZ2VOYW1lO1xuXG4gICAgICAgICAgICBpZiAoZXZlbnQuaXNQcmV2ZW50ZWQoc3RhZ2VOYW1lKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2NhbGxMaWZlY3ljbGVGdW5jdGlvbigncHJldmVudGVkRnVuY3Rpb24nLCBsaWZlY3ljbGVIb3N0LCBldmVudCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHN0YWdlTmFtZSA9PT0gX2RlZmF1bHRTeW1ib2wpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fY29uZmlnLmNvbXBsZXRlT25jZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgb25jZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmV2ZW50ID0gZXZlbnQ7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uZmlnLmNvbXBsZXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY29uZmlnLmRpc3RyaWJ1dG9yID0gcHVibGlzaGVyO1xuICAgICAgICAgICAgICAgIGNvbmZpZy51bnN1YnNjcmliZSA9IG51bGw7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9jYWxsTGlmZWN5Y2xlRnVuY3Rpb24oJ2RlZmF1bHRGdW5jdGlvbicsIGxpZmVjeWNsZUhvc3QsIGV2ZW50KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBbXG4gICAgICAgICAgICAgICAgICAgIGRpc3RyaWJ1dG9yLFxuICAgICAgICAgICAgICAgICAgICBzdGF0ZVxuICAgICAgICAgICAgICAgIF0gb2YgZGlzdHJpYnV0aW9uUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnN1YnNjcmlwdGlvbnNbc3RhZ2VOYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25maWcuZGlzdHJpYnV0b3IgPSBkaXN0cmlidXRvcjtcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHN1YnNjcmlwdGlvbiBvZiBzdGF0ZS5zdWJzY3JpcHRpb25zW3N0YWdlTmFtZV0udmFsdWVzKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy51bnN1YnNjcmliZSA9IHRoaXMuX3Vuc3Vic2NyaWJlLmJpbmQodGhpcywgc3Vic2NyaXB0aW9uKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FsbENhbGxiYWNrRnVuY3Rpb24oc3Vic2NyaXB0aW9uLmNhbGxiYWNrRnVuY3Rpb24sIHN1YnNjcmlwdGlvbi5ob3N0LCBldmVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5kaXNwYXRjaFN0b3BwZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jYWxsTGlmZWN5Y2xlRnVuY3Rpb24oJ2Rpc3BhdGNoU3RvcHBlZEZ1bmN0aW9uJywgbGlmZWN5Y2xlSG9zdCwgZXZlbnQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGlzdHJpYnV0aW9uU3RvcHBlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FsbExpZmVjeWNsZUZ1bmN0aW9uKCdkaXN0cmlidXRpb25TdG9wcGVkRnVuY3Rpb24nLCBsaWZlY3ljbGVIb3N0LCBldmVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZXZlbnQuZXZlbnRTdG9wcGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fY2FsbExpZmVjeWNsZUZ1bmN0aW9uKCdldmVudFN0b3BwZWRGdW5jdGlvbicsIGxpZmVjeWNsZUhvc3QsIGV2ZW50KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChvbmNlKSB7XG4gICAgICAgICAgICBjb25maWcuZGlzdHJpYnV0b3IgPSBwdWJsaXNoZXI7XG4gICAgICAgICAgICBjb25maWcudW5zdWJzY3JpYmUgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSxcbiAgICBzdWJzY3JpYmUgKGNvbmZpZykge1xuICAgICAgICBpZiAodGhpcy5fY29uZmlnLmxpZmVjeWNsZUhvc3QpIHtcbiAgICAgICAgICAgIGNvbmZpZy5saWZlY3ljbGVIb3N0ID0gdGhpcy5fY29uZmlnLmxpZmVjeWNsZUhvc3Q7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY29uZmlnLnB1YmxpY1N1YnNjcmlwdGlvbiAmJiAhdGhpcy5fY29uZmlnLmFsbG93UHVibGljU3Vic2NyaXB0aW9uID9cbiAgICAgICAgICAgIHRoaXMuX1N1YnNjcmlwdGlvbigpIDpcbiAgICAgICAgICAgIHRoaXMuX2NhbGxMaWZlY3ljbGVGdW5jdGlvbignc3Vic2NyaWJlZEZ1bmN0aW9uJywgY29uZmlnLmxpZmVjeWNsZUhvc3QsIHtcbiAgICAgICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICAgICAgZGlzcGF0Y2hlcjogdGhpc1xuICAgICAgICAgICAgfSkgfHwgdGhpcy5fc3Vic2NyaWJlKGNvbmZpZyk7XG4gICAgfSxcbiAgICBfY2FsbENhbGxiYWNrRnVuY3Rpb24gKGNhbGxiYWNrRnVuY3Rpb24sIGhvc3QgPSB0aGlzLCAuLi5hcmdzKSB7XG4gICAgICAgIHN3aXRjaCAodHlwZW9mIGNhbGxiYWNrRnVuY3Rpb24pIHtcbiAgICAgICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVmbGVjdC5hcHBseShjYWxsYmFja0Z1bmN0aW9uLCBob3N0LCBhcmdzKTtcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgICBjYXNlICdzeW1ib2wnOlxuICAgICAgICAgICAgICAgIGNhbGxiYWNrRnVuY3Rpb24gPSBob3N0W2NhbGxiYWNrRnVuY3Rpb25dO1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFja0Z1bmN0aW9uID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LmFwcGx5KGNhbGxiYWNrRnVuY3Rpb24sIGhvc3QsIGFyZ3MpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgX2NhbGxMaWZlY3ljbGVGdW5jdGlvbiAobmFtZSwgbGlmZWN5Y2xlSG9zdCwgLi4uYXJncykge1xuICAgICAgICByZXR1cm4gdGhpcy5fY2FsbENhbGxiYWNrRnVuY3Rpb24odGhpcy5fY29uZmlnW25hbWVdLCBsaWZlY3ljbGVIb3N0LCAuLi5hcmdzKTtcbiAgICB9LFxuICAgIGdldCBfRXZlbnQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fY29uZmlnLkV2ZW50IHx8IHRoaXMuY29uc3RydWN0b3IuX0V2ZW50O1xuICAgIH0sXG4gICAgX2dldE9uY2VDYWxsYmFja0Z1bmN0aW9uIChjYWxsYmFja0Z1bmN0aW9uLCBob3N0ID0gdGhpcykge1xuICAgICAgICBzd2l0Y2ggKHR5cGVvZiBjYWxsYmFja0Z1bmN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50XG4gICAgICAgICAgICAgICAgICAgIF0gPSBhcmdzO1xuXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnVuc3Vic2NyaWJlKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuYXBwbHkoY2FsbGJhY2tGdW5jdGlvbiwgaG9zdCwgYXJncyk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgICBjYXNlICdzeW1ib2wnOlxuICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBbXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudFxuICAgICAgICAgICAgICAgICAgICBdID0gYXJncztcblxuICAgICAgICAgICAgICAgICAgICBldmVudC51bnN1YnNjcmliZSgpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrRnVuY3Rpb24gPSBob3N0W2NhbGxiYWNrRnVuY3Rpb25dO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2tGdW5jdGlvbiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuYXBwbHkoY2FsbGJhY2tGdW5jdGlvbiwgaG9zdCwgYXJncyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGV2ZW50ID0+IHtcbiAgICAgICAgICAgIGV2ZW50LnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH07XG4gICAgfSxcbiAgICBfaW5pdCAoY29uZmlnID0ge30pIHtcbiAgICAgICAgY29uZmlnID0ge1xuICAgICAgICAgICAgLi4uY29uZmlnXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGNvbmZpZy5hbGxvd0R1cGxpY2F0ZVN1YnNjcmlwdGlvbiAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGNvbmZpZy5hbGxvd0R1cGxpY2F0ZVN1YnNjcmlwdGlvbiA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29uZmlnLmFsbG93UHVibGljUHVibGlzaCAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGNvbmZpZy5hbGxvd1B1YmxpY1B1Ymxpc2ggPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbmZpZy5hbGxvd1B1YmxpY1N1YnNjcmlwdGlvbiAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGNvbmZpZy5hbGxvd1B1YmxpY1N1YnNjcmlwdGlvbiA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29uZmlnLmFsbG93UHVibGljVW5zdWJzY3JpcHRpb24gIT09IGZhbHNlKSB7XG4gICAgICAgICAgICBjb25maWcuYWxsb3dQdWJsaWNVbnN1YnNjcmlwdGlvbiA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25maWcuY29tcGxldGVPbmNlID0gY29uZmlnLnB1Ymxpc2hPbmNlID9cbiAgICAgICAgICAgIGZhbHNlIDpcbiAgICAgICAgICAgICEhY29uZmlnLmNvbXBsZXRlT25jZTtcblxuICAgICAgICBpZiAoY29uZmlnLmRpc3BhdGNoU3RvcHBhYmxlICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgY29uZmlnLmRpc3BhdGNoU3RvcHBhYmxlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25maWcuZGlzdHJpYnV0YWJsZSAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGNvbmZpZy5kaXN0cmlidXRhYmxlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25maWcuZGlzdHJpYnV0aW9uU3RvcHBhYmxlICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgY29uZmlnLmRpc3RyaWJ1dGlvblN0b3BwYWJsZSA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29uZmlnLmV2ZW50U3RvcHBhYmxlICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgY29uZmlnLmV2ZW50U3RvcHBhYmxlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25maWcucHJldmVudGFibGUgIT09IGZhbHNlICYmICEoY29uZmlnLnByZXZlbnRhYmxlIGluc3RhbmNlb2YgU2V0KSkge1xuICAgICAgICAgICAgY29uZmlnLnByZXZlbnRhYmxlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbmZpZy5wdWJsaXNoT25jZSA9ICEhY29uZmlnLnB1Ymxpc2hPbmNlO1xuXG4gICAgICAgIGlmICghY29uZmlnLnN0YWdlcykge1xuICAgICAgICAgICAgY29uZmlnLnN0YWdlcyA9IFtcbiAgICAgICAgICAgICAgICAnYmVmb3JlJyxcbiAgICAgICAgICAgICAgICAnb24nLFxuICAgICAgICAgICAgICAgIF9kZWZhdWx0U3ltYm9sLFxuICAgICAgICAgICAgICAgICdhZnRlcidcbiAgICAgICAgICAgIF07XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSxcbiAgICBfc3Vic2NyaWJlIChjb25maWcpIHtcbiAgICAgICAgaWYgKGNvbmZpZy5zdGF0ZS5ldmVudCkge1xuICAgICAgICAgICAgaWYgKCFjb25maWcuc3RhdGUuZXZlbnQuaXNQcmV2ZW50ZWQoY29uZmlnLnN0YXRlLmV2ZW50LnN0YWdlTmFtZSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jYWxsQ2FsbGJhY2tGdW5jdGlvbihjb25maWcuY2FsbGJhY2tGdW5jdGlvbiwgY29uZmlnLmhvc3QsIGNvbmZpZy5zdGF0ZS5ldmVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9TdWJzY3JpcHRpb24oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25maWcub25jZSkge1xuICAgICAgICAgICAgY29uZmlnLm9uY2VDYWxsYmFja0Z1bmN0aW9uID0gY29uZmlnLmNhbGxiYWNrRnVuY3Rpb247XG4gICAgICAgICAgICBjb25maWcuY2FsbGJhY2tGdW5jdGlvbiA9IHRoaXMuX2dldE9uY2VDYWxsYmFja0Z1bmN0aW9uKGNvbmZpZy5jYWxsYmFja0Z1bmN0aW9uLCBjb25maWcuaG9zdCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc3Vic2NyaXB0aW9ucyA9IGNvbmZpZy5zdGF0ZS5zdWJzY3JpcHRpb25zW2NvbmZpZy5zdGFnZU5hbWVdO1xuXG4gICAgICAgIGlmICghc3Vic2NyaXB0aW9ucykge1xuICAgICAgICAgICAgc3Vic2NyaXB0aW9ucyA9IG5ldyBNYXAoKTtcbiAgICAgICAgICAgIGNvbmZpZy5zdGF0ZS5zdWJzY3JpcHRpb25zW2NvbmZpZy5zdGFnZU5hbWVdID0gc3Vic2NyaXB0aW9ucztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5fY29uZmlnLmFsbG93RHVwbGljYXRlU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHN1YnNjcmlwdGlvbiBvZiBzdWJzY3JpcHRpb25zLnZhbHVlcygpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5ob3N0ID09PSBjb25maWcuaG9zdCAmJiAoc3Vic2NyaXB0aW9uLmNhbGxiYWNrRnVuY3Rpb24gPT09IGNvbmZpZy5jYWxsYmFja0Z1bmN0aW9uIHx8IHN1YnNjcmlwdGlvbi5vbmNlQ2FsbGJhY2tGdW5jdGlvbiAmJiBzdWJzY3JpcHRpb24ub25jZUNhbGxiYWNrRnVuY3Rpb24gPT09IGNvbmZpZy5vbmNlQ2FsbGJhY2tGdW5jdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX1N1YnNjcmlwdGlvbigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbmZpZy5zdWJzY3JpcHRpb25JZCA9IFN5bWJvbCgnc3Vic2NyaXB0aW9uSWQnKTtcbiAgICAgICAgY29uZmlnLnVuc3Vic2NyaWJlID0gKHtcbiAgICAgICAgICAgIHB1YmxpY1Vuc3Vic2NyaXB0aW9uXG4gICAgICAgIH0gPSB7fSkgPT4gKCFwdWJsaWNVbnN1YnNjcmlwdGlvbiB8fCB0aGlzLl9jb25maWcuYWxsb3dQdWJsaWNVbnN1YnNjcmlwdGlvbikgJiYgdGhpcy5fdW5zdWJzY3JpYmUoY29uZmlnKTtcblxuICAgICAgICBzdWJzY3JpcHRpb25zLnNldChjb25maWcuc3Vic2NyaXB0aW9uSWQsIGNvbmZpZyk7XG5cbiAgICAgICAgY29uZmlnLnN1YnNjcmlwdGlvbiA9IHtcbiAgICAgICAgICAgIHN1YnNjcmliZWQ6IHRydWUsXG4gICAgICAgICAgICB1bnN1YnNjcmliZTogY29uZmlnLnVuc3Vic2NyaWJlXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX1N1YnNjcmlwdGlvbihjb25maWcuc3Vic2NyaXB0aW9uKTtcbiAgICB9LFxuICAgIGdldCBfU3Vic2NyaXB0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZy5TdWJzY3JpcHRpb24gfHwgdGhpcy5jb25zdHJ1Y3Rvci5fU3Vic2NyaXB0aW9uO1xuICAgIH0sXG4gICAgX3Vuc3Vic2NyaWJlIChjb25maWcpIHtcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9ucyA9IGNvbmZpZy5zdGF0ZS5zdWJzY3JpcHRpb25zW2NvbmZpZy5zdGFnZU5hbWVdLFxuXG4gICAgICAgICAgICBzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zICYmIHN1YnNjcmlwdGlvbnMuZ2V0KGNvbmZpZy5zdWJzY3JpcHRpb25JZCk7XG5cbiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2NhbGxMaWZlY3ljbGVGdW5jdGlvbigndW5zdWJzY3JpYmVkRnVuY3Rpb24nLCBjb25maWcubGlmZWN5Y2xlSG9zdCwge1xuICAgICAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgICAgICBkaXNwYXRjaGVyOiB0aGlzXG4gICAgICAgICAgICB9KSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnMuZGVsZXRlKGNvbmZpZy5zdWJzY3JpcHRpb25JZCk7XG5cbiAgICAgICAgICAgIGlmICghc3Vic2NyaXB0aW9ucy5zaXplKSB7XG4gICAgICAgICAgICAgICAgUmVmbGVjdC5kZWxldGVQcm9wZXJ0eShjb25maWcuc3RhdGUuc3Vic2NyaXB0aW9ucywgY29uZmlnLnN0YWdlTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25maWcuc3Vic2NyaXB0aW9uLnN1YnNjcmliZWQgPSBmYWxzZTtcbiAgICAgICAgY29uZmlnLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSA9IG51bGw7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxufSwge1xuICAgIF9FdmVudCxcbiAgICBfU3Vic2NyaXB0aW9uXG59KTtcblxuZXhwb3J0IHtcbiAgICBfRGlzcGF0Y2hlciBhcyBkZWZhdWx0LFxuICAgIF9FdmVudCBhcyBFdmVudCxcbiAgICBfU3Vic2NyaXB0aW9uIGFzIFN1YnNjcmlwdGlvblxufTtcbiJdfQ==